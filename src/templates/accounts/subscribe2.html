{% extends '_base.html' %}

{% block content %}
<div class="container mt-5 rounded-lg" style="background: linear-gradient(to right, #f5f5f5, #e0e0e0);">
  <div class="row justify-content-center">
    <div class="col-lg-6 text-center">
      <h2 class="mb-4" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);">Choose a Subscription Plan</h2>
      
      <form method="post" action="{{ url_for('core.subscribe') }}" class="rounded-lg p-4 bg-light">
        {% for plan_id, plan_name in plans %}
          <label class="d-block mb-3">
            <input type="radio" name="plan" value="{{ plan_id }}" {% if loop.index == 1 %}checked{% endif %}>
            <span class="text-primary">{{ plan_name }}</span>
          </label>
        {% endfor %}
        <button type="button" onclick="payWithPaystack()" class="btn btn-primary btn-lg btn-block rounded-pill" style="box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2); transition: all 0.2s ease-in-out;">Subscribe</button>
      </form>
    </div>
  </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
    function payWithPaystack() {
      var plan = document.querySelector('input[name="plan"]:checked').value;
      var amount;
      if (plan === 'free') {
        amount = 0;  // Set your desired amount for free trial
      } else if (plan === 'basic') {
        amount = 500000;  // N5,000.00 in kobo
      } else if (plan === 'premium') {
        amount = 1000000;  // N10,000.00 in kobo
      }

      var handler = PaystackPop.setup({
        key: 'pk_test_c20bcd860020d30ee10fd89aa1938f532342f3f7',
        email: '{{ user.email }}',  // Access the template variable
        amount: amount,
        ref: '' + Math.floor((Math.random() * 1000000000) + 1),
        metadata: {
          custom_fields: [
            {
              display_name: "Mobile Number",
              variable_name: "mobile_number",
              value: "+2348012345678"
            }
          ]
        },
        callback: function (response) {
          // Handle the successful payment and update user subscription details
          alert('Success. Transaction ref is ' + response.reference);
          window.location.href = "{{ url_for('core.dashboard') }}";  // Redirect to the dashboard
        },
        onClose: function () {
          alert('Window closed');
        }
      });

      handler.openIframe();
    }
  </script>
{% endblock %}
