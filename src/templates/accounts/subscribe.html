{% extends '_base.html' %}

{% block content %}
<div class="container mt-5 rounded-lg" style="background: linear-gradient(to right, #f5f5f5, #e0e0e0);">
  <div class="row justify-content-center">
    <div class="col-lg-6 text-center">
      <h2 class="mb-4" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);">Choose a Subscription Plan</h2>

      <form method="post" action="{{ url_for('core.subscribe') }}" class="rounded-lg p-4 bg-light" id="paymentForm">
        <div class="form-group">
          <label for="plan">Select a Plan</label>
          <select id="plan" name="plan" class="form-control" required>
            <option value="" disabled selected>Select a Plan</option> <!-- Placeholder -->
            {% for plan_id, plan_info in plans %}
            <option value="{{ plan_id }}" data-cost="{{ plan_info['cost'] }}" {% if user_info['selected_plan'] == plan_id %}selected{% endif %}>
              {{ plan_info['name'] }}
            </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-group">
          <label for="planCost">Plan Cost</label>
          <input type="text" id="planCost" name="planCost" class="form-control" readonly>
        </div>
        
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script>
          $(document).ready(function () {
            // Trigger the change event initially to set the initial plan cost
            updatePlanCost();
        
            // Bind the change event to update the plan cost when a different plan is selected
            $('#plan').change(function () {
              updatePlanCost();
            });
        
            function updatePlanCost() {
              var selectedPlan = $('#plan').find(':selected');
              var planCost = selectedPlan.data('cost');
              $('#planCost').val(planCost);
            }
          });
        </script>

        <div class="form-group">
          <label for="first-name">First Name</label>
          <input type="text" id="first-name" name="first_name" value="{{ user_info['first_name'] }}" />
        </div>

        <div class="form-group">
          <label for="last-name">Last Name</label>
          <input type="text" id="last-name" name="last_name" value="{{ user_info['last_name'] }}" />
        </div>

        <div class="form-group">
          <label for="email-address">Email Address</label>
          <input type="email" id="email-address" name="email" value="{{ user_info['email'] }}" required class="wider-input" />
        </div>

        <div class="form-submit">
          <button type="button" onclick="payWithPaystack()" class="btn btn-primary btn-lg btn-block rounded-pill" style="box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2); transition: all 0.2s ease-in-out;">Pay</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  document.getElementById('plan').addEventListener('change', function () {
      var selectedPlan = this.value;
      var selectedPlanInfo = plans[selectedPlan];
      document.getElementById('amount').value = selectedPlanInfo['cost'];
  });
</script>

<!-- Add a hidden input to store the plan ID -->
<input type="hidden" id="selectedPlan" name="selectedPlan">

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
  var paymentForm = document.getElementById('paymentForm');
  paymentForm.addEventListener('submit', payWithPaystack, false);

  function payWithPaystack() {
    var selectedPlan = document.getElementById('plan').value;
    document.getElementById('selectedPlan').value = selectedPlan;

    var handler = PaystackPop.setup({
      key: 'pk_live_87a006b15465670cb102ad321c55abaa4e32fdb1',
      first_name: document.getElementById('first-name').value,
      last_name: document.getElementById('last-name').value,
      email: document.getElementById('email-address').value,
      amount: document.getElementById('planCost').value * 100, // Multiply by 100 to convert to the lowest currency unit
      currency: 'NGN', // Use GHS for Ghana Cedis or USD for US Dollars
      ref: '' + Math.floor((Math.random() * 1000000000) + 1),
      callback: function(response) {
        if (response.status === 'success') {
          // Update the selected plan on successful payment
          document.getElementById('selectedPlan').value = selectedPlan;

          // Handle the successful payment and update user subscription details
          alert('Success. Transaction ref is ' + response.reference);
          window.location.href = "{{ url_for('core.dashboard') }}"; // Redirect to the dashboard
        } else {
          alert('Payment failed. Reason: ' + response.message);
        }
      },
      onClose: function() {
        alert('Window closed');
      }
    });

    handler.openIframe();
  }
</script>

{% endblock %}
